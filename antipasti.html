<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/output.css">
    <title>Antipasti - Sniper Ristorante</title>
</head>
<body>
    <!-- HEADER -->
    <header class="w-full h-[420px] bg-zinc-900 bg-home bg-cover bg-center">
        <div class="w-full h-full flex flex-col justify-center items-center">
            <img 
                src="./assets/ristorante.png"
                alt="Logo Ristorante"
                class="w-32 h-32 rounded-full shadow-lg hover:scale-110 duration-200"
            /> 
            <h1 class="text-4xl mt-4 mb-2 font-bold text-white">
                Sniper Ristorante - Antipasti
            </h1>
            <span class="text-white font-medium">Via A, 123, Rome</span>
            <div class="bg-orange-500 px-4 py-1 rounded-lg mt-5" id="date-span">
                <span class="text-white font-medium">Aperto tutti i giorni, dalle 11:00 alle 23:59</span>
            </div>
        </div>
    </header>
    <!-- FIM DO HEADER -->

    <h2 class="text-2xl md:text-3xl font-bold text-center mt-9 mb-6">
        Antipasti
    </h2>

    <!-- TOTAL DO CARRINHO -->
    <div class="text-center mb-6">
        <p class="text-lg font-bold">Scontrino: <span id="total-price" class="text-orange-500">€0,00</span></p>
        <p class="text-lg font-bold">Carrelo: <span id="total-quantity" class="text-orange-500">0</span></p>
        <button id="finalize-order" class="bg-orange-500 text-white px-4 py-2 rounded mt-4">Confirmar Pedido</button>
        <button id="clear-cart" class="bg-orange-500 text-white px-4 py-2 rounded mt-4 ml-4">Limpar Carrinho</button> <!-- Botão de limpar carrinho adicionado -->
    </div>

    <!-- INICIO DO ITEM ANTIPASTI -->
    <div class="px-4" id="menu-container">
        <main class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Item 1 -->
            <div class="flex flex-col items-center" id="dish-1">
                <img src="./assets/bruschetta.png" alt="Bruschetta" class="w-28 h-28 rounded-md hover:scale-110 hover:-rotate-2 duration-300" />
                <p class="font-bold">Bruschetta</p>
                <p class="text-sm text-gray-600">Pane tostato su una griglia con olio d'oliva e poi strofinato con aglio.</p>
                <p class="text-orange-500 font-semibold mt-2">€10,00</p>
                <div class="flex items-center mt-2">
                    <button class="bg-orange-500 text-white px-2 py-1 rounded" onclick="adjustQuantity(10.00, 1, 1)">+</button>
                    <span class="mx-2"></span> <!-- Espaçamento entre os botões -->
                    <button class="bg-orange-500 text-white px-2 py-1 rounded" onclick="adjustQuantity(10.00, -1, 1)">-</button>
                </div>
            </div>
            <!-- Item 2 -->
            <div class="flex flex-col items-center" id="dish-2">
                <img src="./assets/caprese.png" alt="Caprese" class="w-28 h-28 rounded-md hover:scale-110 hover:-rotate-2 duration-300" />
                <p class="font-bold">Insalata Caprese</p>
                <p class="text-sm text-gray-600">Insalata Caprese</p>
                <p class="text-orange-500 font-semibold mt-2">€3,00</p>
                <div class="flex items-center mt-2">
                    <button class="bg-orange-500 text-white px-2 py-1 rounded" onclick="adjustQuantity(3.00, 1, 2)">+</button>
                    <span class="mx-2"></span> <!-- Espaçamento entre os botões -->
                    <button class="bg-orange-500 text-white px-2 py-1 rounded" onclick="adjustQuantity(3.00, -1, 2)">-</button>
                </div>
            </div>
        </main>
    </div>
    <!-- FIM DOS ITENS DE ANTIPASTI -->

    <!-- FIM DO MENU -->

    <script>
        let total = 0;
        let totalQuantity = 0;
        const cartItems = []; // Array para armazenar os itens do carrinho

        // Função para carregar os pratos da API
        async function loadDishes() {
            try {
                const response = await fetch('http://localhost:3001/api/pratos/antipasti'); // Substitua pela sua rota de antipasti
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const dishes = await response.json();
                displayDishes(dishes);
            } catch (error) {
                console.error('Erro ao carregar os pratos:', error);
            }
        }

        // Função para exibir os pratos na página
        function displayDishes(dishes) {
            dishes.forEach(dish => {
                // Atualiza o prato específico no DOM
                const dishElement = document.getElementById(`dish-${dish.id}`);
                if (dishElement) {
                    const descriptionElement = dishElement.querySelector('p:nth-child(3)');
                    const priceElement = dishElement.querySelector('p:nth-child(4)');
                    descriptionElement.innerText = dish.description;
                    priceElement.innerText = `€${dish.price.toFixed(2)}`;
                    // Atualiza a função de ajustar quantidade com o preço correto
                    dishElement.querySelector('button:nth-child(1)').setAttribute('onclick', `adjustQuantity(${dish.price}, 1, ${dish.id})`);
                    dishElement.querySelector('button:nth-child(3)').setAttribute('onclick', `adjustQuantity(${dish.price}, -1, ${dish.id})`);
                }
            });
        }

        // Função para ajustar a quantidade no carrinho
        function adjustQuantity(price, change, dishId) {
            const existingItem = cartItems.find(item => item.id === dishId);
            
            // Não permite reduzir abaixo de 0
            if (change < 0 && (!existingItem || existingItem.quantity === 0)) {
                return;
            }

            totalQuantity += change;
            totalQuantity = Math.max(0, totalQuantity); // Garante que não fique negativo

            total += change > 0 ? price : -price;
            total = Math.max(0, total); // Garante que o total não fique negativo

            // Atualiza os itens do carrinho
            if (change > 0) {
                // Adiciona ou atualiza o prato no carrinho
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cartItems.push({ id: dishId, price: price, quantity: 1 });
                }
            } else {
                // Reduz a quantidade ou remove o prato do carrinho
                if (existingItem && existingItem.quantity > 0) {
                    existingItem.quantity--;
                    if (existingItem.quantity === 0) {
                        const itemIndex = cartItems.indexOf(existingItem);
                        cartItems.splice(itemIndex, 1); // Remove se a quantidade for 0
                    }
                }
            }

            updateDisplay();
        }

        // Função para atualizar a exibição do carrinho
        function updateDisplay() {
            document.getElementById("total-price").innerText = `€${total.toFixed(2)}`;
            document.getElementById("total-quantity").innerText = totalQuantity;
        }

        // Função para finalizar o pedido
        async function finalizeOrder() {
            if (totalQuantity === 0) {
                alert('Adicione itens ao carrinho antes de confirmar o pedido.');
                return;
            }

            try {
                const response = await fetch('http://localhost:3001/api/pedidos', { // Substitua pela sua rota de pedidos
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cartItems), // Envia os itens do carrinho
                });

                if (response.ok) {
                    alert('Pedido confirmado com sucesso!');
                    // Limpa o carrinho
                    clearCart();
                } else {
                    throw new Error('Erro ao confirmar o pedido.');
                }
            } catch (error) {
                console.error('Erro ao confirmar o pedido:', error);
            }
        }

        // Função para limpar o carrinho
        function clearCart() {
            total = 0;
            totalQuantity = 0;
            cartItems.length = 0; // Limpa os itens do carrinho
            updateDisplay();
        }

        document.getElementById("finalize-order").addEventListener("click", finalizeOrder);
        document.getElementById("clear-cart").addEventListener("click", clearCart);

        loadDishes(); // Carrega os pratos ao carregar a página
    </script>
</body>
</html>
